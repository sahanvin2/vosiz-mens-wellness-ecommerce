option_settings:
  aws:elasticbeanstalk:container:php:phpini:
    memory_limit: 512M
    upload_max_filesize: 64M
    post_max_size: 64M
    max_execution_time: 300
    max_input_time: 300
    date.timezone: UTC
    
  aws:elasticbeanstalk:application:environment:
    APP_ENV: production
    APP_DEBUG: false
    LOG_CHANNEL: errorlog
    SESSION_DRIVER: database
    CACHE_DRIVER: redis
    QUEUE_CONNECTION: sqs
    
commands:
  01_install_redis_extension:
    command: |
      if ! php -m | grep -q redis; then
        sudo yum install -y gcc gcc-c++ make
        sudo pecl install redis
        echo "extension=redis.so" | sudo tee /etc/php.d/40-redis.ini
      fi
    ignoreErrors: true
    
  02_install_mongodb_extension:
    command: |
      if ! php -m | grep -q mongodb; then
        sudo yum install -y gcc gcc-c++ make autoconf
        sudo pecl install mongodb
        echo "extension=mongodb.so" | sudo tee /etc/php.d/50-mongodb.ini
      fi
    ignoreErrors: true

container_commands:
  01_migrate:
    command: "php artisan migrate --force"
    leader_only: true
  02_cache_config:
    command: "php artisan config:cache"
  03_cache_routes:
    command: "php artisan route:cache"
  04_cache_views:
    command: "php artisan view:cache"
  05_storage_link:
    command: "php artisan storage:link"
    ignoreErrors: true